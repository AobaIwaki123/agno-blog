{% extends "base.html" %}

{% block title %}記事一覧 - Agno Blog{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-journal-text"></i> ブログ記事一覧
            </h2>
            <a href="/" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 新しい記事を作成
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Filters and Search -->
    <div class="col-lg-3">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-funnel"></i> フィルター
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="searchInput" class="form-label">検索</label>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="タイトルで検索...">
                </div>
                
                <div class="mb-3">
                    <label for="templateFilter" class="form-label">テンプレート</label>
                    <select class="form-select" id="templateFilter">
                        <option value="">すべて</option>
                        <option value="default">デフォルト</option>
                        <option value="tech-tutorial">技術チュートリアル</option>
                        <option value="news-article">ニュース記事</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="sortBy" class="form-label">並び順</label>
                    <select class="form-select" id="sortBy">
                        <option value="created_desc">作成日時（新しい順）</option>
                        <option value="created_asc">作成日時（古い順）</option>
                        <option value="title_asc">タイトル（昇順）</option>
                        <option value="title_desc">タイトル（降順）</option>
                    </select>
                </div>
                
                <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                    <i class="bi bi-search"></i> フィルターを適用
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart"></i> 統計
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">総記事数</small>
                    <div class="h5 mb-0" id="totalCount">0</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">今月の記事</small>
                    <div class="h6 mb-0" id="monthlyCount">0</div>
                </div>
                <div>
                    <small class="text-muted">平均文字数</small>
                    <div class="h6 mb-0" id="avgWordCount">0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Posts List -->
    <div class="col-lg-9">
        <div id="postsContainer">
            <!-- Loading spinner -->
            <div class="text-center py-5" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
                <p class="mt-2 text-muted">記事を読み込み中...</p>
            </div>
            
            <!-- Posts will be loaded here -->
            <div id="postsList" style="display: none;"></div>
            
            <!-- Empty state -->
            <div id="emptyState" style="display: none;">
                <div class="text-center py-5">
                    <i class="bi bi-journal-x display-1 text-muted"></i>
                    <h4 class="mt-3 text-muted">記事がありません</h4>
                    <p class="text-muted">まだブログ記事が作成されていません。</p>
                    <a href="/" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> 最初の記事を作成
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="記事ページネーション" id="pagination" style="display: none;">
            <ul class="pagination justify-content-center">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Post Detail Modal -->
<div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postModalLabel">記事詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Post content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('modalBody').innerText)">
                    <i class="bi bi-clipboard"></i> コピー
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPosts = [];
let filteredPosts = [];
let currentPage = 1;
const postsPerPage = 6;

document.addEventListener('DOMContentLoaded', function() {
    loadPosts();
});

async function loadPosts() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const postsList = document.getElementById('postsList');
    const emptyState = document.getElementById('emptyState');
    
    try {
        const response = await fetch('/api/posts');
        const result = await response.json();
        
        loadingSpinner.style.display = 'none';
        
        if (result.posts && result.posts.length > 0) {
            currentPosts = result.posts;
            filteredPosts = [...currentPosts];
            
            updateStats(result);
            displayPosts();
            
            postsList.style.display = 'block';
        } else {
            emptyState.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading posts:', error);
        loadingSpinner.style.display = 'none';
        showAlert('記事の読み込みに失敗しました', 'danger');
    }
}

function updateStats(result) {
    document.getElementById('totalCount').textContent = result.total || 0;
    
    // Calculate monthly count
    const thisMonth = new Date().getMonth();
    const thisYear = new Date().getFullYear();
    const monthlyCount = result.posts.filter(post => {
        const postDate = new Date(post.created_at);
        return postDate.getMonth() === thisMonth && postDate.getFullYear() === thisYear;
    }).length;
    document.getElementById('monthlyCount').textContent = monthlyCount;
    
    // Calculate average word count
    const avgWordCount = result.posts.length > 0 
        ? Math.round(result.posts.reduce((sum, post) => sum + (post.word_count || 0), 0) / result.posts.length)
        : 0;
    document.getElementById('avgWordCount').textContent = avgWordCount;
}

function displayPosts() {
    const postsList = document.getElementById('postsList');
    const pagination = document.getElementById('pagination');
    
    // Calculate pagination
    const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
    const startIndex = (currentPage - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    const postsToShow = filteredPosts.slice(startIndex, endIndex);
    
    // Generate posts HTML
    const postsHtml = postsToShow.map(post => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">
                            <a href="#" class="text-decoration-none" onclick="showPostDetail('${post.id}')">
                                ${post.title}
                            </a>
                        </h5>
                        <p class="card-text text-muted">
                            ${post.content ? post.content.substring(0, 150) + '...' : 'コンテンツなし'}
                        </p>
                        <div class="d-flex flex-wrap gap-1">
                            ${post.tags ? post.tags.map(tag => `
                                <span class="badge bg-secondary">${tag}</span>
                            `).join('') : ''}
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <small class="text-muted d-block">
                            <i class="bi bi-calendar"></i> 
                            ${new Date(post.created_at).toLocaleDateString('ja-JP')}
                        </small>
                        <small class="text-muted d-block">
                            <i class="bi bi-file-earmark-text"></i> 
                            ${post.template_used || 'default'}
                        </small>
                        <small class="text-muted d-block">
                            <i class="bi bi-clock"></i> 
                            ${post.reading_time || 1}分で読める
                        </small>
                        ${post.url_source ? `
                            <small class="text-muted d-block">
                                <i class="bi bi-link-45deg"></i> 
                                <a href="${post.url_source}" target="_blank" class="text-muted">元記事</a>
                            </small>
                        ` : ''}
                        
                        <div class="mt-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="showPostDetail('${post.id}')">
                                <i class="bi bi-eye"></i> 詳細
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard(\`${post.content ? post.content.replace(/`/g, '\\`') : ''}\`)">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    postsList.innerHTML = postsHtml;
    
    // Generate pagination
    if (totalPages > 1) {
        const paginationHtml = generatePaginationHtml(currentPage, totalPages);
        pagination.innerHTML = paginationHtml;
        pagination.style.display = 'block';
    } else {
        pagination.style.display = 'none';
    }
}

function generatePaginationHtml(current, total) {
    let html = '<ul class="pagination justify-content-center">';
    
    // Previous button
    html += `
        <li class="page-item ${current === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${current - 1})">前へ</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= total; i++) {
        if (i === current) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else if (i === 1 || i === total || (i >= current - 1 && i <= current + 1)) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
        } else if (i === current - 2 || i === current + 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    // Next button
    html += `
        <li class="page-item ${current === total ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${current + 1})">次へ</a>
        </li>
    `;
    
    html += '</ul>';
    return html;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayPosts();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const templateFilter = document.getElementById('templateFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    // Filter posts
    filteredPosts = currentPosts.filter(post => {
        const matchesSearch = !searchTerm || post.title.toLowerCase().includes(searchTerm);
        const matchesTemplate = !templateFilter || post.template_used === templateFilter;
        
        return matchesSearch && matchesTemplate;
    });
    
    // Sort posts
    filteredPosts.sort((a, b) => {
        switch (sortBy) {
            case 'created_desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'created_asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'title_asc':
                return a.title.localeCompare(b.title);
            case 'title_desc':
                return b.title.localeCompare(a.title);
            default:
                return 0;
        }
    });
    
    currentPage = 1;
    displayPosts();
}

async function showPostDetail(postId) {
    try {
        const response = await fetch(`/api/posts/${postId}`);
        const post = await response.json();
        
        if (response.ok) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="mb-4">
                    <h2>${post.title}</h2>
                    <div class="text-muted mb-3">
                        <small>
                            <i class="bi bi-calendar"></i> ${new Date(post.created_at).toLocaleString('ja-JP')} |
                            <i class="bi bi-file-earmark-text"></i> ${post.template_used} |
                            <i class="bi bi-clock"></i> ${post.reading_time}分で読める
                            ${post.url_source ? `| <i class="bi bi-link-45deg"></i> <a href="${post.url_source}" target="_blank">元記事</a>` : ''}
                        </small>
                    </div>
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="mb-3">
                            ${post.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="border p-3 bg-light">
                    <div style="white-space: pre-wrap;">${post.content || 'コンテンツがありません'}</div>
                </div>
            `;
            
            document.getElementById('postModalLabel').textContent = post.title;
            
            const modal = new bootstrap.Modal(document.getElementById('postModal'));
            modal.show();
        } else {
            showAlert('記事の詳細を取得できませんでした', 'danger');
        }
    } catch (error) {
        console.error('Error loading post detail:', error);
        showAlert('記事の詳細を取得できませんでした', 'danger');
    }
}

// Initialize filters on input
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('templateFilter').addEventListener('change', applyFilters);
document.getElementById('sortBy').addEventListener('change', applyFilters);
</script>
{% endblock %}